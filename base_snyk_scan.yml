#
# Base job to run Snyk scan on docker image
#
# Run a scan on the main image using `SNYK_TOKEN` CI variable
#

.base_snyk_scan:
  image: node:12-alpine
  services:
    - docker:$DOCKER_VERSION-dind
  dependencies: []
  when: manual
  allow_failure: true
  variables:
    IMAGE: "${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHA}"
  script:
    - echo "$CI_JOB_TOKEN" | docker login $CI_REGISTRY -u gitlab-ci-token --password-stdin
    - docker pull $IMAGE
    - docker run --rm snyk/snyk-cli:1.305.0-docker snyk test --org=socialgouv --docker $IMAGE --file=./Dockerfile
    - yarn --frozen-lockfile --production
    - docker run --rm snyk/snyk-cli:1.305.0-docker snyk test --org=socialgouv --file=package.json
